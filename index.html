<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geology Clicker Game</title>
    <style>
        :root { 
            --main-bg-color: #D7CCC8; --text-color: #3E2723; --accent-color: #BF360C;
            --ui-light: #EFEBE9; --ui-dark: #8D6E63;
            --rock-color-1: #795548; --rock-color-2: #5D4037;
            --progress-bg: #5D4037; --progress-fill: #76FF03;
        }
        
        /* NUCLEAR OPTION: Disable zooming and selection on EVERYTHING */
        * { 
            box-sizing: border-box; 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--main-bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden;
            color: var(--text-color);
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
        }
        
        #login-container { text-align: center; }
        #game-wrapper { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        /* Header Layout */
        .static-header { padding: 10px 10px 5px 10px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; width: 100%; position: relative; }
        .locked-feature { display: none !important; }

        /* Help Button */
        #help-btn {
            position: absolute; top: 10px; right: 10px;
            width: 30px; height: 30px; border-radius: 50%;
            background-color: var(--ui-dark); color: white;
            border: none; font-weight: bold; font-size: 18px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; padding: 0; margin: 0; box-shadow: none;
        }

        /* Global Stats Bar */
        #global-stats-bar { display: flex; justify-content: space-between; width: 100%; max-width: 450px; font-size: 12px; color: var(--text-color); margin-bottom: 3px; }
        #global-stats-bar span { font-weight: bold; }

        /* Progress Bar */
        #party-progress-container { width: 100%; max-width: 450px; margin-bottom: 5px; text-align: center; }
        #progress-bar-bg { width: 100%; height: 15px; background-color: var(--progress-bg); border-radius: 10px; overflow: hidden; border: 1px solid #3E2723; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); position: relative; }
        #progress-bar-fill { height: 100%; width: 0%; background-color: var(--progress-fill); background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent); background-size: 20px 20px; transition: width 0.5s ease-in-out; }
        #progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; text-shadow: 1px 1px 2px black; line-height: 1; }

        .main-content { flex-grow: 1; width: 100%; overflow-y: auto; padding: 10px 20px 80px 20px; transition: transform 0.5s ease-in-out; -webkit-overflow-scrolling: touch; position: relative; }
        .page { display: none; flex-direction: column; align-items: center; text-align: center; padding-bottom: 20px; }
        .page.active { display: flex; }
        
        /* Tab Nav */
        .tab-nav { display: flex; width: 100%; border-top: 2px solid var(--ui-dark); background-color: #fff; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); position: fixed; bottom: 0; z-index: 1000; height: 60px; }
        .tab-button { flex: 1 1 0px; padding: 0; background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: var(--text-color); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; }
        .tab-button span { font-size: 20px; }
        .tab-button.active { background-color: var(--ui-light); border-top: 4px solid var(--accent-color); color: var(--accent-color); }
        
        #shake-wrapper { position: relative; min-height: 50vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 100%; }
        
        #my-score-display { font-size: 28px; font-weight: 900; color: var(--accent-color); margin: 10px 0 0 0; text-shadow: 1px 1px 0px rgba(0,0,0,0.1); }
        #passive-rate-display { font-size: 14px; color: #5D4037; margin: 2px 0 10px 0; font-weight: bold; opacity: 0.8; }
        
        h3 { margin: 15px 0 5px 0; font-size: 16px; text-transform: uppercase; color: var(--text-color); border-bottom: 2px solid var(--ui-dark); width: 100%; max-width: 450px; }
        p { margin: 8px 0; font-size: 18px; }
        
        #leaderboard { margin-top: 15px; border-top: 2px solid var(--ui-dark); padding-top: 10px; width: 100%; max-width: 400px; }
        .leaderboard-entry { display: flex; flex-direction: column; padding: 8px; background-color: var(--ui-light); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--ui-dark); font-weight: bold; font-size: 14px; }
        .leaderboard-info { display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px; }
        .leaderboard-actions { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        
        .my-entry-name { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; color: #BF360C; }
        
        #announcement-bar { width: 100%; max-width: 450px; background-color: #FFF8E1; border: 2px solid #FFB300; border-radius: 8px; height: 120px; overflow: hidden; display: flex; flex-direction: column; }
        .announcement-message { padding: 2px 8px; margin: 0 !important; border-bottom: 1px solid rgba(0,0,0,0.1); text-align: left; animation: slideIn 0.2s ease-out; font-weight: 500; font-size: 12px; display: flex; align-items: center; flex-shrink: 0; line-height: 1.3; min-height: 20px; }
        .announcement-message:last-child { border-bottom: none; }
        
        /* Grid System */
        .upgrades-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 450px; margin-top: 10px; }
        
        /* Upgrade Cards */
        .upgrade-btn {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 8px 5px; height: 100px !important; width: 100% !important; font-size: 13px; 
            margin: 0 !important; border: none; border-radius: 8px; color: white; cursor: pointer;
            box-shadow: 0 3px #3E2723; transition: all 0.1s; line-height: 1.3;
        }
        .upgrade-btn:active { box-shadow: 0 1px #3E2723; transform: translateY(2px); }
        .btn-passive { background-color: #795548; }
        .btn-active { background-color: #5D4037; } 
        .btn-title { font-weight: 900; font-size: 13px; margin-bottom: 4px; display: block; }
        .btn-details { background: rgba(0,0,0,0.2); padding: 4px; border-radius: 4px; width: 95%; display: flex; flex-direction: column; align-items: center; }
        .btn-bonus { font-size: 10px; color: #FFECB3; margin-bottom: 2px; font-style: italic; }
        .btn-cost { font-weight: bold; color: #FFF; font-size: 11px; }
        .hidden-upgrade { display: none !important; }
        
        .msg-high-priority { background-color: #FFECB3; color: #BF360C; font-weight: bold; border-left: 5px solid #FF6F00; }
        .msg-attack { color: #D32F2F; background-color: rgba(255, 205, 210, 0.3); }
        .msg-fun { color: #00796B; }
        .msg-system { color: #5D4037; font-style: italic; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Standard Buttons */
        button { font-size: 16px; padding: 12px 20px; margin-top: 10px; border: none; border-radius: 8px; color: white; background-color: var(--rock-color-1); cursor: pointer; width: 90%; max-width: 350px; font-weight: bold; box-shadow: 0 4px #4E342E; transition: all 0.1s; }
        button:active { box-shadow: 0 1px #4E342E; transform: translateY(3px); }
        button:disabled, .action-button:disabled { background-color: #A1887F !important; cursor: not-allowed !important; box-shadow: none !important; transform: none !important; opacity: 0.6 !important; color: #5D4037 !important; }
        
        .action-button { font-size: 12px; padding: 6px 4px; margin: 0; width: 23%; box-shadow: 0 2px #333; flex-grow: 1; color: white; border-radius: 4px; border: none; cursor: pointer; }
        .crack-button { background-color: #FF5722; }
        .poke-button { background-color: #FF9800; }
        .flip-button { background-color: #03A9F4; }
        .gremlin-button { background-color: #9C27B0; }
        .cat-button { background-color: #009688; }
        #sacrifice-button { background-color: #D32F2F; width: 100%; grid-column: span 2; margin-top: 15px; height: auto; padding: 15px; }
        
        #clicker-button {
            position: relative; transition: top 0.1s ease-out, left 0.1s ease-out, transform 0.1s;
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            width: 220px; height: 200px;
            background: radial-gradient(circle at 30% 30%, var(--rock-color-1), var(--rock-color-2));
            border: none; color: #EFEBE9; padding: 0;
            display: flex; justify-content: center; align-items: center;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.4), inset 10px 10px 20px rgba(255,255,255,0.2), 0 8px 5px rgba(0,0,0,0.3);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-top: 20px;
        }
        #clicker-button h2 { font-size: 32px; margin: 0; pointer-events: none; font-weight: 900; }
        #clicker-button:active { transform: scale(0.97) translateY(3px); box-shadow: inset -8px -8px 15px rgba(0,0,0,0.5), inset 8px 8px 15px rgba(255,255,255,0.1), 0 3px 3px rgba(0,0,0,0.3); }
        #clicker-button.stage-2 { background: repeating-linear-gradient(45deg, var(--rock-color-1), var(--rock-color-2) 10px, #3E2723 10px, #3E2723 12px); border: 2px dashed #3E2723; }
        #clicker-button.stage-3 { background: radial-gradient(circle at 50% 50%, #7B1FA2, var(--rock-color-1)); box-shadow: 0 0 15px #7B1FA2; color: #FFF; }
        #clicker-button.stage-4 { background: radial-gradient(circle at 50% 50%, #FFD700, #BF360C); box-shadow: 0 0 25px #FFD700; animation: pulse 0.5s infinite alternate; color: #000; text-shadow: none; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        .floating-number { position: absolute; color: #FFD700; font-weight: bold; font-size: 24px; pointer-events: none; user-select: none; animation: floatUp 1s ease-out forwards; z-index: 1000; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }
        input { font-size: 18px; padding: 12px; border-radius: 8px; border: 2px solid var(--ui-dark); background-color: var(--ui-light); color: var(--text-color); width: 80%; max-width: 300px; margin-bottom: 10px; }
        #secret-code-container { margin-bottom: 10px; }
        #code-display { display: flex; gap: 8px; justify-content: center; }
        .code-box { width: 40px; height: 55px; border: 2px solid var(--text-color); display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 900; border-radius: 8px; background-color: #FFF8E1; color: var(--text-color); }
        
        .my-stats-display { display: flex; justify-content: center; gap: 10px; margin-top: 10px; font-size: 13px; padding: 10px; border: 2px dashed var(--ui-dark); border-radius: 12px; background-color: #D7CCC8; margin-bottom: 10px; font-weight: bold; width: 100%; flex-wrap: wrap; }
        
        /* Sticky Header for Upgrades Mass */
        #sticky-upgrades-header {
            position: sticky; top: -20px; z-index: 100;
            background-color: var(--main-bg-color);
            width: 100%; padding: 10px;
            border-bottom: 1px solid var(--ui-dark);
            font-size: 20px; font-weight: bold; color: var(--accent-color);
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .shake-effect { animation: shake 0.5s infinite; }
        .flip-effect { transform: rotate(180deg); }
        @keyframes shake { 0% { transform: translate(9px, 9px) rotate(0deg); } 10% { transform: translate(-9px, -18px) rotate(-1deg); } 20% { transform: translate(-27px, 0px) rotate(1deg); } 30% { transform: translate(27px, 18px) rotate(0deg); } 40% { transform: translate(9px, -9px) rotate(1deg); } 50% { transform: translate(-9px, 18px) rotate(-1deg); } 60% { transform: translate(-27px, 9px) rotate(0deg); } 70% { transform: translate(27px, 9px) rotate(-1deg); } 80% { transform: translate(-9px, -9px) rotate(1deg); } 90% { transform: translate(9px, 18px) rotate(0deg); } 100% { transform: translate(9px, -18px) rotate(-1deg); } }
        .cat-container { position: fixed; top: 30%; left: -200px; font-size: 150px; line-height: 1; z-index: 1600; pointer-events: none; animation: walk 12s linear forwards; }
        @keyframes walk { 0% { left: -200px; transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } 100% { left: 100%; transform: rotate(0deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        #hidden-cat { position: fixed; bottom: 10px; right: 10px; width: 30px; height: 30px; opacity: 0.01; z-index: 999; cursor: pointer; }
        .screen-crack { position: absolute; width: 200px; height: 200px; pointer-events: none; z-index: 1500; opacity: 0.9; }
        
        /* OVERLAYS */
        .full-screen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(62, 39, 35, 0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; padding: 30px; text-align: center; }
        .full-screen-overlay h2 { color: #FFCC80; margin-bottom: 20px; font-size: 32px; line-height: 1.2; }
        .full-screen-overlay p { color: #EFEBE9; font-size: 20px; margin-bottom: 30px; line-height: 1.5; }
        .full-screen-overlay button { background-color: #BF360C; width: 100%; max-width: 300px; font-size: 22px; padding: 15px; }
        
        #help-overlay ul { text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.5; color: #EFEBE9; padding-left: 20px; max-width: 400px; }
        #help-overlay li { margin-bottom: 10px; }
        #help-overlay strong { color: #FFB300; }
        
        #waiting-overlay p { font-family: monospace; color: #81C784; font-size: 16px; }
        #waiting-spinner { width: 50px; height: 50px; border: 5px solid #EFEBE9; border-top: 5px solid #BF360C; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #lobby-container { width: 100%; max-width: 400px; background-color: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); max-height: 200px; overflow-y: auto; }
        #lobby-container h3 { margin: 0 0 10px 0; color: #FFB300; font-size: 18px; }
        #lobby-list { list-style: none; padding: 0; margin: 0; color: #EFEBE9; text-align: left; }
        #lobby-list li { padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 16px; }
        #earthquake-overlay { background-color: rgba(183, 28, 28, 0.95); }
        #earthquake-overlay h2 { color: #FFF; font-size: 40px; text-transform: uppercase; }
        #earthquake-overlay .sacrificer-name { color: #FFD700; font-weight: bold; font-size: 24px; display: block; margin-bottom: 10px; }
        #earthquake-close-btn { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-size: 40px; cursor: pointer; width: auto; box-shadow: none; padding: 10px; line-height: 1; margin: 0; }
        #earthquake-close-btn:hover { color: white; transform: scale(1.1); }
        #summary-overlay { background-color: #3E2723; padding: 10px; overflow-y: auto; justify-content: flex-start; }
        #summary-content { width: 100%; max-width: 600px; margin-top: 40px; padding-bottom: 40px; }
        .summary-card { background-color: #EFEBE9; color: #3E2723; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 2px solid #8D6E63; text-align: left; }
        .summary-card h3 { margin: 0 0 10px 0; color: #BF360C; font-size: 20px; border-bottom: 1px solid #A1887F; padding-bottom: 5px; display: flex; justify-content: space-between; }
        .summary-stat { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .naughty-list { margin-top: 10px; background-color: #D7CCC8; padding: 10px; border-radius: 5px; }
        .naughty-list h4 { margin: 0 0 5px 0; font-size: 14px; color: #D32F2F; font-weight: 900; }
        .naughty-item { font-size: 12px; padding: 4px 0; border-bottom: 1px dashed #A1887F; line-height: 1.4; }
        .naughty-item strong { color: #3E2723; }
        /* Final Code Display */
        #final-code-display { background-color: #3E2723; color: #FFD700; font-family: monospace; font-size: 60px; font-weight: 900; padding: 20px; border: 4px solid #FFD700; border-radius: 15px; margin-bottom: 30px; letter-spacing: 10px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    </style>
</head>
<body>
    <div id="hidden-cat"></div>
    <div id="login-container" class="page active">
        <h1>Enter Your Geologist Name</h1>
        <input type="text" id="name-input" placeholder="Your Name">
        <button id="join-button">Begin Expedition</button>
    </div>

    <div id="help-overlay" class="full-screen-overlay">
        <h2>How to Play</h2>
        <ul>
            <li><strong>Tap the Rock:</strong> Generate Mass.</li>
            <li><strong>Buy Upgrades:</strong> Increase your output (Active & Passive).</li>
            <li><strong>Prank Friends:</strong> Use the "Pranks" tab to mess with other geologists!</li>
            <li><strong>Trigger Earthquake:</strong> Reset your progress to boost the WHOLE PARTY's multiplier.</li>
            <li><strong>Goal:</strong> Work together to reveal the 4-digit Core Combination!</li>
            <li><em>Tip: If the game freezes, refresh the page. You won't lose progress.</em></li>
        </ul>
        <button id="help-close-btn">Got it!</button>
    </div>

    <div id="tutorial-overlay" class="full-screen-overlay">
        <h2>It's too tough...</h2>
        <p>You cannot break this alone.<br>You need a team of Geologists.</p>
        <button id="start-party-button">Call for Backup</button>
    </div>

    <div id="invite-overlay" class="full-screen-overlay">
        <h2>Expedition Lobby üì°</h2>
        <p style="margin-bottom: 10px;">The channel is open.</p>
        <p style="font-weight: bold; color: #FFCC80; font-size: 18px;">Get others to join via your QR code!</p>
        <div id="lobby-container">
            <h3>Geologists Ready: <span id="lobby-count">0</span></h3>
            <ul id="lobby-list"></ul>
        </div>
        <button id="lets-dig-button" disabled>Waiting for Team...</button>
    </div>

    <div id="waiting-overlay" class="full-screen-overlay">
        <div id="waiting-spinner"></div>
        <h2>Mission Control</h2>
        <p>Connection Established.</p>
        <p>Awaiting launch signal from Expedition Leader...</p>
    </div>
    
    <div id="earthquake-overlay" class="full-screen-overlay">
        <button id="earthquake-close-btn">‚úï</button>
        <h2>EARTHQUAKE!</h2>
        <p><span id="earthquake-user" class="sacrificer-name">Unknown</span> triggered a massive tremor!</p>
        <p>They sacrificed everything to multiply ALL scores by <span id="earthquake-multiplier" style="font-weight:bold;">2x</span>!</p>
    </div>
    
    <div id="summary-overlay" class="full-screen-overlay" style="display: none;">
        <h2>EXPEDITION COMPLETE!</h2>
        <p>The Core has been breached.</p>
        <div id="final-code-display">----</div>
        <div id="summary-content"></div>
    </div>

    <div id="game-wrapper">
        <div class="static-header">
            <button id="help-btn">?</button>

            <div id="secret-code-container" class="locked-feature">
                <h3>Core Combination</h3>
                <div id="code-display">
                    <div class="code-box">?</div><div class="code-box">?</div><div class="code-box">?</div><div class="code-box">?</div>
                </div>
            </div>
            <div id="party-progress-container" class="locked-feature">
                <div id="global-stats-bar">
                    <span>Total Party Mass: <span id="total-mass-display">0</span></span>
                    <span>Earthquake Mult: <span id="header-multiplier">1x</span></span>
                </div>
                <div id="progress-bar-bg">
                    <div id="progress-bar-fill"></div>
                    <div id="progress-text">0%</div>
                </div>
            </div>
            <div id="announcement-bar" class="locked-feature"></div>
        </div>
        <div class="main-content">
            <div id="game-page" class="page active">
                <div id="shake-wrapper">
                    <p id="my-score-display">My Mass: 0</p>
                    <p id="passive-rate-display">(+0/sec)</p>
                    
                    <div class="my-stats-display locked-feature">
                        <span id="stat-geologist" style="display:none">Geologists: <b id="my-helpers-display">0</b></span>
                        <span id="stat-tnt" style="display:none">TNT: <b id="my-tnt-display">0</b></span>
                        <span id="stat-drill" style="display:none">Drills: <b id="my-drills-display">0</b></span>
                        <span id="stat-excavator" style="display:none">Excavators: <b id="my-excavators-display">0</b></span>
                        <span id="stat-pickaxe">Pickaxe: <b id="my-click-power-display">1</b></span>
                        <span id="stat-crit" style="display:none">Crit: <b id="my-crit-display">0%</b></span>
                        <span id="stat-synergy" style="display:none">Synergy: <b id="my-synergy-display">0</b></span>
                    </div>
                    <button id="clicker-button">
                        <h2 id="rock-text">MINE ROCK!</h2>
                    </button>
                </div>
            </div>
            
            <div id="upgrades-page" class="page">
                <div id="sticky-upgrades-header">
                    My Mass: <span id="upgrades-mass-display">0</span>
                </div>
                
                <button id="sacrifice-button" class="hidden-upgrade">Trigger Earthquake! (Cost: <span id="sacrifice-cost-display">7500</span>)</button>
                
                <h3>Tap Power</h3>
                <div class="upgrades-grid">
                    <button class="upgrade-btn btn-active" id="purchase-power-click-button">
                        <span class="btn-title" id="click-title">Pickaxe (Owned: 1)</span>
                        <div class="btn-details">
                            <span class="btn-bonus">+1 Click</span>
                            <span class="btn-cost">Cost: <span id="power-click-cost-display">25</span></span>
                        </div>
                    </button>
                    
                    <button class="upgrade-btn btn-active hidden-upgrade" id="purchase-crit-button">
                        <span class="btn-title" id="crit-title">Lucky Geode</span>
                        <div class="btn-details">
                            <span class="btn-bonus">+1% Crit</span>
                            <span class="btn-cost">Cost: <span id="crit-cost-display">500</span></span>
                        </div>
                    </button>

                    <button class="upgrade-btn btn-active hidden-upgrade" id="purchase-synergy-button">
                        <span class="btn-title" id="synergy-title">Middle Manager</span>
                        <div class="btn-details">
                            <span class="btn-bonus">1% mass/sec added</span>
                            <span class="btn-cost">Cost: <span id="synergy-cost-display">2500</span></span>
                        </div>
                    </button>
                </div>

                <h3>Passive Mass</h3>
                <div class="upgrades-grid">
                    <button class="upgrade-btn btn-passive" id="purchase-helper-button">
                        <span class="btn-title" id="helper-title">Geologist (Owned: 0)</span>
                        <div class="btn-details">
                            <span class="btn-bonus">+1/sec</span>
                            <span class="btn-cost">Cost: <span id="helper-cost-display">15</span></span>
                        </div>
                    </button>

                    <button class="upgrade-btn btn-passive hidden-upgrade" id="purchase-tnt-button">
                        <span class="btn-title" id="tnt-title">TNT Charge</span>
                        <div class="btn-details">
                            <span class="btn-bonus">+10/sec</span>
                            <span class="btn-cost">Cost: <span id="tnt-cost-display">250</span></span>
                        </div>
                    </button>

                    <button class="upgrade-btn btn-passive hidden-upgrade" id="purchase-drill-button">
                        <span class="btn-title" id="drill-title">Ind. Drill</span>
                        <div class="btn-details">
                            <span class="btn-bonus">+50/sec</span>
                            <span class="btn-cost">Cost: <span id="drill-cost-display">1000</span></span>
                        </div>
                    </button>
                    
                    <button class="upgrade-btn btn-passive hidden-upgrade" id="purchase-excavator-button">
                        <span class="btn-title" id="excavator-title">Excavator</span>
                        <div class="btn-details">
                            <span class="btn-bonus">+500/sec</span>
                            <span class="btn-cost">Cost: <span id="excavator-cost-display">15000</span></span>
                        </div>
                    </button>
                </div>
            </div>
            <div id="leaderboard-page" class="page">
                <h1>Geologist Rankings</h1>
                <div id="leaderboard"></div>
            </div>
        </div>
        <nav class="tab-nav locked-feature">
            <button class="tab-button active" data-page="game-page"><span>üñ±Ô∏è</span>Mine</button>
            <button class="tab-button" data-page="upgrades-page"><span>üíé</span>Upgrades</button>
            <button class="tab-button" data-page="leaderboard-page"><span>üé≠</span>Pranks & Ranks</button>
        </nav>
    </div>

    <audio id="click-sound" src="tink.mp3" preload="auto"></audio>
    <audio id="purchase-sound" src="buy.mp3" preload="auto"></audio>
    <audio id="prank-sound" src="laugh.mp3" preload="auto"></audio>
    <audio id="secret-sound" src="chime.mp3" preload="auto"></audio>
    <audio id="sacrifice-sound" src="boom.mp3" preload="auto"></audio>
    <audio id="crack-sound" src="crack.mp3" preload="auto"></audio>
    <audio id="whoosh-sound" src="whoosh.mp3" preload="auto"></audio>
    <audio id="meow-sound" src="meow.mp3" preload="auto"></audio>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        const sounds = {
            click: document.getElementById('click-sound'),
            buy: document.getElementById('purchase-sound'),
            prank: document.getElementById('prank-sound'),
            secret: document.getElementById('secret-sound'),
            sacrifice: document.getElementById('sacrifice-sound'),
            crack: document.getElementById('crack-sound'),
            whoosh: document.getElementById('whoosh-sound'),
            meow: document.getElementById('meow-sound')
        };
        
        // PREVENT ZOOM
        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
        document.addEventListener('dblclick', function(e) { e.preventDefault(); });

        let lastClickSoundTime = 0;
        let canClick = true;

        function unlockAudio() {
            for (let key in sounds) {
                if(sounds[key]) {
                    sounds[key].volume = 0; 
                    sounds[key].play().then(() => {
                        sounds[key].pause();
                        sounds[key].currentTime = 0;
                        sounds[key].volume = 1; 
                    }).catch(e => console.log("Audio warm-up skipped", e));
                }
            }
        }

        const elements = {
            loginContainer: document.getElementById('login-container'),
            gameWrapper: document.getElementById('game-wrapper'),
            mainContent: document.querySelector('.main-content'),
            shakeWrapper: document.getElementById('shake-wrapper'),
            totalMassDisplay: document.getElementById('total-mass-display'),
            headerMultiplier: document.getElementById('header-multiplier'),
            myScoreDisplay: document.getElementById('my-score-display'),
            upgradesMassDisplay: document.getElementById('upgrades-mass-display'),
            passiveRateDisplay: document.getElementById('passive-rate-display'),
            
            clickerButton: document.getElementById('clicker-button'),
            leaderboard: document.getElementById('leaderboard'),
            nameInput: document.getElementById('name-input'),
            joinButton: document.getElementById('join-button'),
            
            // BUTTONS
            purchaseHelperButton: document.getElementById('purchase-helper-button'),
            purchaseTntButton: document.getElementById('purchase-tnt-button'),
            purchaseDrillButton: document.getElementById('purchase-drill-button'),
            purchaseExcavatorButton: document.getElementById('purchase-excavator-button'),
            purchasePowerClickButton: document.getElementById('purchase-power-click-button'),
            purchaseCritButton: document.getElementById('purchase-crit-button'),
            purchaseSynergyButton: document.getElementById('purchase-synergy-button'),
            sacrificeButton: document.getElementById('sacrifice-button'),
            
            // COSTS
            helperCostDisplay: document.getElementById('helper-cost-display'),
            tntCostDisplay: document.getElementById('tnt-cost-display'),
            drillCostDisplay: document.getElementById('drill-cost-display'),
            excavatorCostDisplay: document.getElementById('excavator-cost-display'),
            powerClickCostDisplay: document.getElementById('power-click-cost-display'),
            critCostDisplay: document.getElementById('crit-cost-display'),
            synergyCostDisplay: document.getElementById('synergy-cost-display'),
            sacrificeCostDisplay: document.getElementById('sacrifice-cost-display'),
            
            // TITLES
            helperTitle: document.getElementById('helper-title'),
            tntTitle: document.getElementById('tnt-title'),
            drillTitle: document.getElementById('drill-title'),
            excavatorTitle: document.getElementById('excavator-title'),
            clickTitle: document.getElementById('click-title'),
            critTitle: document.getElementById('crit-title'),
            synergyTitle: document.getElementById('synergy-title'),
            
            announcementBar: document.getElementById('announcement-bar'),
            codeBoxes: document.querySelectorAll('.code-box'),
            
            // STATS Game Tab (WRAPPERS)
            statGeologist: document.getElementById('stat-geologist'),
            statTnt: document.getElementById('stat-tnt'),
            statDrill: document.getElementById('stat-drill'),
            statExcavator: document.getElementById('stat-excavator'),
            statCrit: document.getElementById('stat-crit'),
            statSynergy: document.getElementById('stat-synergy'),
            
            // STAT VALUES
            myHelpersDisplay: document.getElementById('my-helpers-display'),
            myTntDisplay: document.getElementById('my-tnt-display'),
            myDrillsDisplay: document.getElementById('my-drills-display'),
            myExcavatorsDisplay: document.getElementById('my-excavators-display'),
            myClickPowerDisplay: document.getElementById('my-click-power-display'),
            myCritDisplay: document.getElementById('my-crit-display'),
            mySynergyDisplay: document.getElementById('my-synergy-display'),
            
            hiddenCat: document.getElementById('hidden-cat'),
            tabNav: document.querySelector('.tab-nav'),
            pages: document.querySelectorAll('.page'),
            
            tutorialOverlay: document.getElementById('tutorial-overlay'),
            inviteOverlay: document.getElementById('invite-overlay'),
            waitingOverlay: document.getElementById('waiting-overlay'),
            startPartyButton: document.getElementById('start-party-button'),
            letsDigButton: document.getElementById('lets-dig-button'),
            gameTitle: document.getElementById('game-title'),
            rockText: document.getElementById('rock-text'),
            lockedFeatures: document.querySelectorAll('.locked-feature'),
            lobbyList: document.getElementById('lobby-list'),
            lobbyCount: document.getElementById('lobby-count'),
            progressBarFill: document.getElementById('progress-bar-fill'),
            progressText: document.getElementById('progress-text'),
            earthquakeOverlay: document.getElementById('earthquake-overlay'),
            earthquakeUser: document.getElementById('earthquake-user'),
            earthquakeMultiplier: document.getElementById('earthquake-multiplier'),
            earthquakeCloseBtn: document.getElementById('earthquake-close-btn'),
            summaryOverlay: document.getElementById('summary-overlay'),
            summaryContent: document.getElementById('summary-content'),
            finalCodeDisplay: document.getElementById('final-code-display'),
            
            // BUTTON REFS for Visibility & Enabling
            btnHelper: document.getElementById('purchase-helper-button'),
            btnTnt: document.getElementById('purchase-tnt-button'),
            btnDrill: document.getElementById('purchase-drill-button'),
            btnExcavator: document.getElementById('purchase-excavator-button'),
            btnClick: document.getElementById('purchase-power-click-button'),
            btnCrit: document.getElementById('purchase-crit-button'),
            btnSynergy: document.getElementById('purchase-synergy-button'),
            btnSacrifice: document.getElementById('sacrifice-button'),
            
            helpBtn: document.getElementById('help-btn'),
            helpOverlay: document.getElementById('help-overlay'),
            helpCloseBtn: document.getElementById('help-close-btn')
        };
        
        let isGremlined = false;
        let tutorialClicks = 0;
        let gameIsUnlocked = false;
        let hasJoined = false;
        let isHost = false;
        let totalPlayers = 1;
        let myClickPower = 1; 
        let myMulti = 1; 
        let myCritChance = 0;
        let mySynergy = 0;
        let myPassiveIncome = 0;
        let myCurrentScore = 0; 

        function getPlayerId() {
            let playerId = localStorage.getItem('partyClickerPlayerId');
            if (!playerId) {
                playerId = 'player_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('partyClickerPlayerId', playerId);
            }
            return playerId;
        }
        
        function unlockFullGame() {
            gameIsUnlocked = true;
            elements.lockedFeatures.forEach(el => el.classList.remove('locked-feature'));
            elements.rockText.textContent = "MINE ROCK!";
        }
        
        function updateStartButton() {
            if (totalPlayers > 1) {
                elements.letsDigButton.disabled = false;
                elements.letsDigButton.textContent = "Let's Dig!";
                elements.letsDigButton.style.backgroundColor = "#4CAF50"; 
                elements.letsDigButton.style.cursor = "pointer";
            } else {
                elements.letsDigButton.disabled = true;
                elements.letsDigButton.textContent = "Waiting for Team...";
                elements.letsDigButton.style.backgroundColor = "#A1887F";
                elements.letsDigButton.style.cursor = "not-allowed";
            }
        }
        
        function createParticle(x, y, value, isCrit) {
            const particle = document.createElement('div');
            particle.className = 'floating-number';
            if (isCrit) particle.classList.add('crit');
            particle.textContent = (isCrit ? 'CRIT! ' : '+') + Math.floor(value).toLocaleString();
            particle.style.left = `${x}px`;
            particle.style.top = `${y - 80}px`; 
            document.body.appendChild(particle);
            setTimeout(() => { particle.remove(); }, 1000);
        }

        // HELPER: Check Affordability and Gray Out Buttons
        function checkAffordability(cost, buttonElement) {
            if (myCurrentScore < cost) {
                buttonElement.disabled = true;
                buttonElement.style.opacity = '0.5';
                buttonElement.style.filter = 'grayscale(100%)';
            } else {
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
                buttonElement.style.filter = 'none';
            }
        }
        
        // HELPER: Update Button Titles
        const updateBtnTitle = (el, title, count) => {
            el.textContent = count > 0 ? `${title} (Owned: ${count})` : title;
        };

        // LISTENERS FOR REFRESH & RESET
        socket.on('forceRefresh', () => { window.location.reload(); });
        window.resetGameNow = function() { if(confirm("‚ö†Ô∏è ARE YOU SURE? This will wipe the server and kick everyone.")) { socket.emit('adminResetGame'); } }

        elements.joinButton.addEventListener('click', () => {
            const playerName = elements.nameInput.value.trim();
            if (playerName) {
                unlockAudio();
                socket.emit('joinGame', { name: playerName, id: getPlayerId() });
                hasJoined = true; 
                elements.loginContainer.style.display = 'none';
                elements.gameWrapper.style.display = 'flex';
            }
        });

        elements.clickerButton.addEventListener('click', (e) => {
            socket.emit('playerClick');
            if (isGremlined) jumpButton();
            
            // 2 Second Throttle for Mining Sound
            const now = Date.now();
            if (now - lastClickSoundTime > 2000) {
                 if (sounds.click) {
                     const clickClone = sounds.click.cloneNode();
                     clickClone.play().catch(() => {});
                 }
                 lastClickSoundTime = now;
            }

            let x = e.clientX;
            let y = e.clientY;
            if (!x) {
                const rect = elements.clickerButton.getBoundingClientRect();
                x = rect.left + rect.width / 2;
                y = rect.top + rect.height / 2;
            }
            
            const synergyBonus = myPassiveIncome * (mySynergy * 0.01);
            let val = (myClickPower + synergyBonus) * myMulti;
            
            let isCrit = false;
            if (Math.random() * 100 < myCritChance) {
                val *= 10;
                isCrit = true;
            }
            
            createParticle(x, y, val, isCrit);

            if (!gameIsUnlocked) {
                tutorialClicks++;
                if (tutorialClicks >= 10) {
                    elements.tutorialOverlay.style.display = 'flex';
                }
            }
        });
        
        elements.startPartyButton.addEventListener('click', () => {
            socket.emit('unlockGame');
            isHost = true; 
            elements.tutorialOverlay.style.display = 'none';
            updateStartButton();
        });

        elements.letsDigButton.addEventListener('click', () => {
            socket.emit('startExpedition');
            elements.inviteOverlay.style.display = 'none';
        });
        
        elements.earthquakeCloseBtn.addEventListener('click', () => {
            elements.earthquakeOverlay.style.display = 'none';
        });
        
        // HELP BUTTON LOGIC
        elements.helpBtn.addEventListener('click', () => {
            elements.helpOverlay.style.display = 'flex';
        });
        elements.helpCloseBtn.addEventListener('click', () => {
            elements.helpOverlay.style.display = 'none';
        });

        elements.tabNav.addEventListener('click', (event) => { const button = event.target.closest('.tab-button'); if (button) { const pageId = button.dataset.page; elements.pages.forEach(page => page.classList.toggle('active', page.id === pageId)); elements.tabNav.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId)); } });
        
        elements.purchaseHelperButton.addEventListener('click', () => { socket.emit('purchaseHelper'); if(sounds.buy) sounds.buy.play(); });
        elements.purchaseTntButton.addEventListener('click', () => { socket.emit('purchaseTnt'); if(sounds.buy) sounds.buy.play(); });
        elements.purchaseDrillButton.addEventListener('click', () => { socket.emit('purchaseDrill'); if(sounds.buy) sounds.buy.play(); });
        elements.purchaseExcavatorButton.addEventListener('click', () => { socket.emit('purchaseExcavator'); if(sounds.buy) sounds.buy.play(); });
        elements.purchasePowerClickButton.addEventListener('click', () => { socket.emit('purchasePowerClick'); if(sounds.buy) sounds.buy.play(); });
        elements.purchaseCritButton.addEventListener('click', () => { socket.emit('purchaseCrit'); if(sounds.buy) sounds.buy.play(); });
        elements.purchaseSynergyButton.addEventListener('click', () => { socket.emit('purchaseSynergy'); if(sounds.buy) sounds.buy.play(); });
        elements.sacrificeButton.addEventListener('click', () => socket.emit('sacrificeForParty')); 
        
        elements.hiddenCat.addEventListener('click', () => { socket.emit('foundHiddenCat'); elements.hiddenCat.style.display = 'none'; });
        
        elements.leaderboard.addEventListener('click', (event) => { 
            if (event.target.classList.contains('my-entry-name')) {
                socket.emit('foundHiddenCat');
                event.target.style.color = '#3E2723';
                event.target.style.cursor = 'default';
                event.target.style.textDecoration = 'none';
            }

            if (event.target.classList.contains('action-button')) { 
                const targetPlayerId = event.target.dataset.playerId; 
                
                // HARDCODED COSTS FOR CLIENT CHECK
                let cost = 0;
                if (event.target.classList.contains('crack-button')) cost = 100;
                else if (event.target.classList.contains('cat-button')) cost = 250;
                else if (event.target.classList.contains('flip-button')) cost = 500;
                else if (event.target.classList.contains('gremlin-button')) cost = 750;

                if (myCurrentScore >= cost) {
                    if (event.target.classList.contains('poke-button')) socket.emit('crackPlayer', targetPlayerId); 
                    else if (event.target.classList.contains('flip-button')) socket.emit('flipPlayer', targetPlayerId); 
                    else if (event.target.classList.contains('gremlin-button')) socket.emit('gremlinPlayer', targetPlayerId);
                    else if (event.target.classList.contains('cat-button')) socket.emit('sendCat', targetPlayerId);
                    if(sounds.buy) sounds.buy.play(); // Feedback sound
                }
            } 
        });

        socket.on('gameStateUpdate', (state) => {
            if (state.isGameUnlocked && !state.isExpeditionStarted) {
                if (hasJoined) {
                    if (isHost) {
                        elements.inviteOverlay.style.display = 'flex';
                        elements.waitingOverlay.style.display = 'none';
                    } else {
                        elements.inviteOverlay.style.display = 'none';
                        elements.waitingOverlay.style.display = 'flex';
                    }
                    unlockFullGame();
                }
            }
            
            if (state.isExpeditionStarted) {
                elements.inviteOverlay.style.display = 'none';
                elements.waitingOverlay.style.display = 'none';
                unlockFullGame();
            }

            const { players, partyMultiplier, sacrificeCost, nextGoal } = state;
            
            myMulti = partyMultiplier;

            const totalScore = Object.values(players).reduce((sum, player) => sum + player.score, 0);
            let percentage = 0;
            if (nextGoal > 0) percentage = Math.min(100, (totalScore / nextGoal) * 100);
            else percentage = 100;
            elements.progressBarFill.style.width = `${percentage}%`;
            elements.progressText.textContent = `${Math.floor(percentage)}%`;
            
            const btn = elements.clickerButton;
            btn.className = ''; 
            if (percentage > 33) btn.classList.add('stage-2');
            if (percentage > 66) btn.classList.add('stage-3');
            if (percentage > 90) btn.classList.add('stage-4');

            if (isHost && elements.inviteOverlay.style.display === 'flex') {
                elements.lobbyList.innerHTML = '';
                const playerNames = Object.values(players).map(p => p.name);
                totalPlayers = playerNames.length;
                elements.lobbyCount.textContent = totalPlayers;
                updateStartButton();
                playerNames.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    elements.lobbyList.appendChild(li);
                });
            }

            elements.leaderboard.innerHTML = '';
            const playerArray = Object.values(players);
            playerArray.sort((a, b) => b.score - a.score);
            
            elements.totalMassDisplay.textContent = Math.floor(totalScore).toLocaleString();
            elements.headerMultiplier.textContent = `${partyMultiplier}x`;
            
            elements.sacrificeCostDisplay.textContent = sacrificeCost.toLocaleString();
            const myId = getPlayerId();
            
            playerArray.forEach(player => {
                const entry = document.createElement('div');
                entry.classList.add('leaderboard-entry');
                const playerEntryId = Object.keys(players).find(id => players[id] === player);
                let actionsHTML = '';
                if (playerEntryId !== myId) {
                    actionsHTML = `
                        <div class="leaderboard-actions">
                            <button class="action-button poke-button crack-button" data-player-id="${playerEntryId}">Crack (100)</button>
                            <button class="action-button cat-button" data-player-id="${playerEntryId}">Cat (250)</button>
                            <button class="action-button flip-button" data-player-id="${playerEntryId}">Shift (500)</button>
                            <button class="action-button gremlin-button" data-player-id="${playerEntryId}">Fissure (750)</button>
                        </div>
                    `;
                }
                
                let nameHTML = `<span>${player.name}</span>`;
                if (playerEntryId === myId && !player.foundSecret) { 
                    nameHTML = `<span class="my-entry-name" title="Is there a secret here?">${player.name}</span>`;
                }

                entry.innerHTML = `
                    <div class="leaderboard-info">${nameHTML} <span>${Math.floor(player.score).toLocaleString()}</span></div>
                    ${actionsHTML}
                `;
                elements.leaderboard.appendChild(entry);
            });
            
            // *** VISUAL UPDATE LOOP ***
            const myServerState = players[myId];
            if (myServerState) {
                myCurrentScore = myServerState.score; // Critical for checkAffordability
                myClickPower = myServerState.clickPower;
                myCritChance = myServerState.critChance || 0;
                mySynergy = myServerState.synergyLevel || 0;
                myPassiveIncome = (myServerState.helpers * 1) + ((myServerState.tnt || 0) * 10) + ((myServerState.drills || 0) * 50) + ((myServerState.excavators || 0) * 500);
                
                // FOG OF WAR VISIBILITY
                const lifetime = myServerState.totalEarnedMass || 0;
                
                const updateVisibilityAndStats = (cost, btn, countDisplay, statEl, count) => {
                    if (lifetime < cost * 0.66) btn.classList.add('hidden-upgrade'); 
                    else btn.classList.remove('hidden-upgrade');
                    checkAffordability(cost, btn); // Visually disable if broke
                    countDisplay.textContent = count || 0;
                    if(statEl) statEl.style.display = (count || 0) > 0 ? 'inline' : 'none';
                };

                updateVisibilityAndStats(myServerState.nextHelperCost, elements.btnHelper, elements.helperCountDisplay, elements.statGeologist, myServerState.helpers);
                updateVisibilityAndStats(myServerState.nextTntCost, elements.btnTnt, elements.tntCountDisplay, elements.statTnt, myServerState.tnt);
                updateVisibilityAndStats(myServerState.nextDrillCost, elements.btnDrill, elements.drillCountDisplay, elements.statDrill, myServerState.drills);
                updateVisibilityAndStats(myServerState.nextExcavatorCost, elements.btnExcavator, elements.excavatorCountDisplay, elements.statExcavator, myServerState.excavators);
                updateVisibilityAndStats(myServerState.nextCritCost, elements.btnCrit, elements.critCountDisplay, elements.statCrit, myServerState.critChance);
                updateVisibilityAndStats(myServerState.nextSynergyCost, elements.btnSynergy, elements.synergyCountDisplay, elements.statSynergy, myServerState.synergyLevel);
                
                // Pickaxe always visible
                checkAffordability(myServerState.nextPowerClickCost, elements.btnClick);
                elements.clickCountDisplay.textContent = myServerState.clickPower;
                
                // Sacrifice
                if (lifetime < 7500 * 0.66) elements.sacrificeButton.classList.add('hidden-upgrade'); 
                else elements.sacrificeButton.classList.remove('hidden-upgrade');
                checkAffordability(sacrificeCost, elements.sacrificeButton);
                
                // Update Prank Buttons (Check Affordability only)
                const prankButtons = document.querySelectorAll('.leaderboard-actions .action-button');
                prankButtons.forEach(btn => {
                    let cost = 100; // Default crack
                    if (btn.classList.contains('cat-button')) cost = 250;
                    else if (btn.classList.contains('flip-button')) cost = 500;
                    else if (btn.classList.contains('gremlin-button')) cost = 750;
                    checkAffordability(cost, btn);
                });

                const myScoreText = `My Mass: ${Math.floor(myServerState.score).toLocaleString()}`;
                elements.myScoreDisplay.textContent = myScoreText;
                elements.upgradesMassDisplay.textContent = Math.floor(myServerState.score).toLocaleString();
                elements.passiveRateDisplay.textContent = `(+${Math.floor(myPassiveIncome * myMulti).toLocaleString()}/sec)`;
                
                // STAT VISIBILITY & VALUES
                updateBtnTitle(elements.helperTitle, "Geologist", myServerState.helpers);
                updateBtnTitle(elements.tntTitle, "TNT Charge", myServerState.tnt || 0);
                updateBtnTitle(elements.drillTitle, "Ind. Drill", myServerState.drills || 0);
                updateBtnTitle(elements.excavatorTitle, "Excavator", myServerState.excavators || 0);
                updateBtnTitle(elements.critTitle, "Lucky Geode", myServerState.critChance || 0);
                updateBtnTitle(elements.synergyTitle, "Middle Manager", myServerState.synergyLevel || 0);
                updateBtnTitle(elements.clickTitle, "Pickaxe", myServerState.clickPower);

                // COSTS
                elements.helperCostDisplay.textContent = myServerState.nextHelperCost.toLocaleString();
                elements.tntCostDisplay.textContent = (myServerState.nextTntCost || 250).toLocaleString();
                elements.drillCostDisplay.textContent = (myServerState.nextDrillCost || 1000).toLocaleString();
                elements.excavatorCostDisplay.textContent = (myServerState.nextExcavatorCost || 15000).toLocaleString();
                elements.powerClickCostDisplay.textContent = myServerState.nextPowerClickCost.toLocaleString();
                elements.critCostDisplay.textContent = (myServerState.nextCritCost || 500).toLocaleString();
                elements.synergyCostDisplay.textContent = (myServerState.nextSynergyCost || 2500).toLocaleString();
            }
        });
        
        socket.on('gameUnlocked', () => {
            if (elements.tutorialOverlay.style.display === 'flex' || tutorialClicks >= 10) {
                 isHost = true; 
                 elements.inviteOverlay.style.display = 'flex';
                 updateStartButton();
            }
            unlockFullGame();
        });
        
        socket.on('earthquakeTriggered', (data) => {
            elements.earthquakeUser.textContent = data.name;
            elements.earthquakeMultiplier.textContent = `${data.multiplier}x`;
            elements.earthquakeOverlay.style.display = 'flex';
            if(sounds.sacrifice) {
                sounds.sacrifice.play();
                if(window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate([200, 100, 200, 100, 500]);
                }
            }
        });
        
        socket.on('gameOver', (data) => {
            const players = data.players;
            const fullCode = data.fullCode;
            
            elements.summaryOverlay.style.display = 'flex';
            elements.finalCodeDisplay.textContent = fullCode; 
            elements.summaryContent.innerHTML = '';
            
            const playerArray = Object.values(players);
            const maxMass = Math.max(...playerArray.map(p => p.totalEarnedMass));
            const maxQuakes = Math.max(...playerArray.map(p => p.sacrifices));
            playerArray.sort((a, b) => b.totalEarnedMass - a.totalEarnedMass);
            
            playerArray.forEach(player => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                let badges = '';
                if (player.totalEarnedMass === maxMass) badges += ' üí∞ TYCOON';
                if (player.sacrifices > 0 && player.sacrifices === maxQuakes) badges += ' üåã HERO';
                
                let naughtylistHTML = '';
                if (player.history && Object.keys(player.history).length > 0) {
                    naughtylistHTML = `<div class="naughty-list"><h4>üòà Attacks Sent By ${player.name}:</h4>`;
                    for (const [targetName, stats] of Object.entries(player.history)) {
                        let actions = [];
                        if (stats.cracks > 0) actions.push(`${stats.cracks} Cracks`);
                        if (stats.cats > 0) actions.push(`${stats.cats} Cats`);
                        if (stats.flips > 0) actions.push(`${stats.flips} Flips`);
                        if (stats.gremlins > 0) actions.push(`${stats.gremlins} Fissures`);
                        if (actions.length > 0) {
                            naughtylistHTML += `<div class="naughty-item"><strong>Target: ${targetName}</strong> ‚Üí ${actions.join(', ')}</div>`;
                        }
                    }
                    naughtylistHTML += `</div>`;
                } else {
                    naughtylistHTML = `<div class="naughty-list"><h4>üòà Attacks Sent:</h4><div class="naughty-item" style="color: green;">üòá A perfect angel! (No attacks sent)</div></div>`;
                }
                card.innerHTML = `
                    <h3>${player.name} ${badges}</h3>
                    <div class="summary-stat"><span>Final Mass Score:</span> <strong>${Math.floor(player.totalEarnedMass).toLocaleString()}</strong></div>
                    <div class="summary-stat" style="margin-top: 10px; border-top: 1px dashed #A1887F; padding-top: 5px;"><strong>Lifetime Upgrades:</strong></div>
                    <div class="summary-stat"><span>Geologists:</span> <strong>${player.totalHelpers || 0}</strong></div>
                    <div class="summary-stat"><span>TNT:</span> <strong>${player.totalTnt || 0}</strong></div>
                    <div class="summary-stat"><span>Drills:</span> <strong>${player.totalDrills || 0}</strong></div>
                    <div class="summary-stat"><span>Excavators:</span> <strong>${player.totalExcavators || 0}</strong></div>
                    <div class="summary-stat"><span>Pickaxe Upgrades:</span> <strong>${player.totalClickUpgrades || 0}</strong></div>
                    
                    <div class="summary-stat" style="border-top: 1px solid #ccc; margin-top: 5px; padding-top: 5px;"><span>Earthquakes:</span> <strong>${player.sacrifices || 0}</strong></div>
                    <div class="summary-stat" style="color:#D32F2F;">
                        <span>Total Mass Wasted on Pranks:</span> <strong>${(player.attackCost || 0).toLocaleString()}</strong>
                    </div>
                    ${naughtylistHTML}
                `;
                elements.summaryContent.appendChild(card);
            });
        });

        socket.on('unlockCodePiece', (data) => { if (elements.codeBoxes[data.position]) { elements.codeBoxes[data.position].textContent = data.code; } if(sounds.secret) sounds.secret.play(); });
        
        socket.on('announcement', (data) => {
            const messageElement = document.createElement('p');
            messageElement.className = 'announcement-message';
            messageElement.textContent = data.text;
            
            const txt = data.text.toLowerCase();
            if (txt.includes('sacrificed') || txt.includes('earthquake') || txt.includes('excavation') || txt.includes('fossil')) {
                messageElement.classList.add('msg-high-priority');
            } else if (txt.includes('smashed') || txt.includes('shifted') || txt.includes('fissure')) {
                messageElement.classList.add('msg-attack');
            } else if (txt.includes('mole') || txt.includes('cat')) {
                messageElement.classList.add('msg-fun');
            } else {
                messageElement.classList.add('msg-system');
            }

            elements.announcementBar.prepend(messageElement);
            if (elements.announcementBar.childElementCount > 8) {
                elements.announcementBar.lastChild.remove();
            }
        });

        socket.on('youGotCracked', () => {
            const crackImg = document.createElement('img');
            crackImg.src = 'crack.png';
            crackImg.className = 'screen-crack';
            const x = Math.random() * (window.innerWidth - 200);
            const y = Math.random() * (window.innerHeight - 200);
            crackImg.style.left = x + 'px';
            crackImg.style.top = y + 'px';
            crackImg.style.transform = `rotate(${Math.random() * 360}deg)`;
            document.body.appendChild(crackImg);
            if(sounds.crack) sounds.crack.play();
            setTimeout(() => { crackImg.remove(); }, 15000);
        });
        socket.on('youGotFlipped', () => { elements.mainContent.classList.add('flip-effect'); setTimeout(() => { elements.mainContent.classList.remove('flip-effect'); }, 15000); if(sounds.whoosh) sounds.whoosh.play(); });
        socket.on('youGotGremlined', () => { isGremlined = true; elements.clickerButton.style.boxShadow = '0 0 25px 10px #9C27B0'; setTimeout(() => { isGremlined = false; elements.clickerButton.style.top = '0px'; elements.clickerButton.style.left = '0px'; elements.clickerButton.style.boxShadow = 'inset -10px -10px 20px rgba(0,0,0,0.4), inset 10px 10px 20px rgba(255,255,255,0.2), 0 8px 5px rgba(0,0,0,0.3)'; }, 30000); if(sounds.prank) sounds.prank.play(); });
        socket.on('catAttack', () => {
            const cats = ['üêà', 'üòª', 'üôÄ'];
            const randomCat = cats[Math.floor(Math.random() * cats.length)];
            const catElement = document.createElement('div');
            catElement.className = 'cat-container';
            catElement.textContent = randomCat;
            document.body.appendChild(catElement);
            if(sounds.meow) sounds.meow.play();
            setTimeout(() => { catElement.remove(); }, 12500);
        });
        function jumpButton() { const container = elements.shakeWrapper; const button = elements.clickerButton; const containerWidth = container.offsetWidth; const buttonWidth = button.offsetWidth; const containerHeight = container.offsetHeight; const buttonHeight = button.offsetHeight; const maxX = (containerWidth - buttonWidth) / 2; const maxY = (containerHeight - buttonHeight) / 2; const randomLeftOffset = (Math.random() * 2 - 1) * maxX; const randomTopOffset = (Math.random() * 2 - 1) * maxY; button.style.left = `${randomLeftOffset}px`; button.style.top = `${randomTopOffset}px`; }
    </script>
</body>
</html>